{"version":3,"sources":["../src/index.ts","../src/useEaoAnalytics.ts","../src/utils/tokenExtractor.ts","../src/utils/apiClient.ts"],"sourcesContent":["export { trackAnalytics } from './useEaoAnalytics';\nexport type {\n  EpicAppName,\n  EaoAnalyticsOptions,\n  UserInfo,\n  EaoAnalyticsPayload,\n} from './types';\n\n","import { useEffect, useRef, useState } from 'react';\nimport { useAuth } from 'react-oidc-context';\nimport { extractUserInfo } from './utils/tokenExtractor';\nimport { trackLogin } from './utils/apiClient';\nimport { EaoAnalyticsOptions } from './types';\n\nconst ANALYTICS_DEBOUNCE_MS = 5000; // 5 seconds\nconst SESSION_STORAGE_KEY = 'epic_eao_analytics_last_recorded';\n\ninterface AnalyticsState {\n  lastRecorded: number;\n  appName: string;\n}\n\n/**\n * React hook to record user login analytics across EPIC applications\n * Automatically records login analytics when user is authenticated\n */\n\n\n/**\n * React hook to record user login analytics across EPIC applications\n * Automatically records login analytics when user is authenticated\n */\nexport function trackAnalytics(options: EaoAnalyticsOptions) {\n  const { appName, centreApiUrl, enabled = true, onSuccess, onError, authState } = options;\n  let user: any;\n  let isAuthenticated: boolean;\n\n  // Try to use useAuth hook, but don't crash if it's not available or fails\n  let authContext: any = {};\n  try {\n    authContext = useAuth();\n  } catch (e) {\n    // augment the error handling or just ignore if we expect to rely on authState\n  }\n\n  if (authState) {\n    user = authState.user;\n    isAuthenticated = authState.isAuthenticated;\n  } else {\n    user = authContext.user;\n    isAuthenticated = authContext.isAuthenticated;\n  }\n\n  const [isRecording, setIsRecording] = useState(false);\n  const [error, setError] = useState<Error | null>(null);\n  const recordingRef = useRef(false);\n\n  useEffect(() => {\n    if (!enabled || !isAuthenticated || !user) {\n      return;\n    }\n\n    if (recordingRef.current) {\n      return;\n    }\n\n    const stored = sessionStorage.getItem(SESSION_STORAGE_KEY);\n    if (stored) {\n      const state: AnalyticsState = JSON.parse(stored);\n      const timeSinceLastRecord = Date.now() - state.lastRecorded;\n\n      // If same app and recorded recently, skip\n      if (state.appName === appName && timeSinceLastRecord < ANALYTICS_DEBOUNCE_MS) {\n        return;\n      }\n    }\n\n    // Check if identity_provider is \"idir\" - only send analytics for IDIR users\n    // Skip this check if authState was manually injected (assumes IDIR-only app)\n    if (!authState) {\n      const identityProvider = user.profile?.identity_provider;\n      if (identityProvider !== 'idir') {\n        return;\n      }\n    }\n\n    // Extract user info from token\n    const userInfo = extractUserInfo(user);\n    if (!userInfo) {\n      console.warn('EAO Analytics: Could not extract user info from token');\n      return;\n    }\n\n    // Get access token\n    const accessToken = user.access_token;\n    if (!accessToken) {\n      console.warn('EAO Analytics: No access token available');\n      return;\n    }\n\n    // Record analytics\n    const performAnalytics = async () => {\n      recordingRef.current = true;\n      setIsRecording(true);\n      setError(null);\n\n      try {\n        await trackLogin(centreApiUrl, accessToken, {\n          user_auth_guid: userInfo.user_auth_guid,\n          app_name: appName,\n        });\n\n        // Store analytics state in sessionStorage\n        sessionStorage.setItem(\n          SESSION_STORAGE_KEY,\n          JSON.stringify({\n            lastRecorded: Date.now(),\n            appName,\n          } as AnalyticsState)\n        );\n\n\n        onSuccess?.();\n      } catch (err) {\n        const error = err instanceof Error ? err : new Error('Unknown error');\n        setError(error);\n        onError?.(error);\n      } finally {\n        setIsRecording(false);\n        recordingRef.current = false;\n      }\n    };\n\n    performAnalytics();\n  }, [isAuthenticated, user, appName, centreApiUrl, enabled, onSuccess, onError]);\n\n  return {\n    isRecording,\n    error,\n  };\n}\n\n","import { User } from 'react-oidc-context';\nimport { UserInfo } from '../types';\n\n/**\n * Extract user_auth_guid from OIDC user object\n * Uses preferred_username as user_auth_guid\n */\nexport function extractUserInfo(user: User | null | undefined): UserInfo | null {\n  if (!user || !user.profile) {\n    return null;\n  }\n\n  const profile = user.profile;\n\n  const user_auth_guid = profile.preferred_username || profile.sub;\n  \n  if (!user_auth_guid) {\n    return null;\n  }\n\n  return {\n    user_auth_guid,\n  };\n}\n\n","import { EaoAnalyticsPayload } from '../types';\n\n/**\n * Record user login analytics by calling EPIC.centre API\n * @param apiUrl - Base URL of EPIC.centre API\n * @param accessToken - User's access token for authentication\n * @param payload - EAO Analytics payload\n */\nexport async function trackLogin(\n  apiUrl: string,\n  accessToken: string,\n  payload: EaoAnalyticsPayload\n): Promise<void> {\n  if (!apiUrl) {\n    throw new Error('EPIC.centre API URL is required');\n  }\n\n  if (!accessToken) {\n    throw new Error('Access token is required');\n  }\n\n  const baseUrl = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;\n  const endpoint = `${baseUrl}/api/eao-analytics`;\n\n  try {\n    const response = await fetch(endpoint, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify(payload),\n      keepalive: true,\n    });\n\n    if (!response.ok) {\n      throw new Error(\n        `EAO Analytics recording failed: ${response.status} ${response.statusText}`\n      );\n    }\n  } catch (error) {\n    throw error instanceof Error ? error : new Error('EAO Analytics recording failed: Unknown error');\n  }\n}\n\n"],"mappings":"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","names":["error"]}