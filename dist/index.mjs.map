{"version":3,"sources":["../src/useEaoAnalytics.ts","../src/utils/tokenExtractor.ts","../src/utils/apiClient.ts"],"sourcesContent":["import { useEffect, useRef, useState } from 'react';\nimport { useAuth } from 'react-oidc-context';\nimport { extractUserInfo } from './utils/tokenExtractor';\nimport { trackLogin } from './utils/apiClient';\nimport { EaoAnalyticsOptions } from './types';\n\nconst DEBOUNCE_MS = 5000;\nconst STORAGE_KEY = 'epic_eao_analytics_last_recorded';\n\n/**\n * Hook to record IDIR user login analytics for EPIC applications.\n *\n * Usage:\n *   // Apps using react-oidc-context (Submit, Compliance, Conditions):\n *   trackAnalytics({ appName: 'epic_submit', centreApiUrl: '...' });\n *\n *   // Apps using Redux (Engage, Track):\n *   trackAnalytics({\n *     appName: 'epic_engage',\n *     centreApiUrl: '...',\n *     authState: { user, isAuthenticated }\n *   });\n */\nexport function trackAnalytics(options: EaoAnalyticsOptions) {\n  const {\n    appName,\n    centreApiUrl,\n    enabled = true,\n    onSuccess,\n    onError,\n    authState,\n  } = options;\n\n  // Get user from either injected authState or react-oidc-context\n  const { user, isAuthenticated } = useAuthState(authState);\n\n  const [isRecording, setIsRecording] = useState(false);\n  const [error, setError] = useState<Error | null>(null);\n  const hasRecorded = useRef(false);\n\n  useEffect(() => {\n    // Skip if disabled, not authenticated, or already recording\n    if (!enabled || !isAuthenticated || !user || hasRecorded.current) {\n      return;\n    }\n\n    // Skip if we recorded recently (debounce)\n    if (wasRecentlyRecorded(appName)) {\n      return;\n    }\n\n    // For apps using react-oidc-context, check if user is IDIR\n    // For apps using authState (Redux), assume IDIR-only\n    if (!authState && !isIdirUser(user)) {\n      return;\n    }\n\n    // Extract user info\n    const userInfo = extractUserInfo(user);\n    if (!userInfo) {\n      console.warn('EAO Analytics: Could not extract user info');\n      return;\n    }\n\n    const accessToken = user.access_token;\n    if (!accessToken) {\n      console.warn('EAO Analytics: No access token available');\n      return;\n    }\n\n    // Record the analytics\n    recordAnalytics();\n\n    async function recordAnalytics() {\n      hasRecorded.current = true;\n      setIsRecording(true);\n      setError(null);\n\n      try {\n        await trackLogin(centreApiUrl, accessToken, {\n          user_auth_guid: userInfo!.user_auth_guid,\n          app_name: appName,\n        });\n\n        saveRecordedTimestamp(appName);\n        onSuccess?.();\n      } catch (err) {\n        const e = err instanceof Error ? err : new Error('Unknown error');\n        setError(e);\n        onError?.(e);\n      } finally {\n        setIsRecording(false);\n        hasRecorded.current = false;\n      }\n    }\n  }, [isAuthenticated, user, appName, centreApiUrl, enabled, onSuccess, onError, authState]);\n\n  return { isRecording, error };\n}\n\n// --- Helper Functions ---\n\n/**\n * Get user authentication state from either injected authState or useAuth hook.\n */\nfunction useAuthState(authState?: EaoAnalyticsOptions['authState']) {\n  // If authState is provided, use it directly\n  if (authState) {\n    return {\n      user: authState.user,\n      isAuthenticated: authState.isAuthenticated,\n    };\n  }\n\n  // Otherwise, use the react-oidc-context hook\n  // This will throw if not wrapped in AuthProvider, which is expected\n  const auth = useAuth();\n  return {\n    user: auth.user,\n    isAuthenticated: auth.isAuthenticated,\n  };\n}\n\n/**\n * Check if user has IDIR identity provider.\n */\nfunction isIdirUser(user: any): boolean {\n  return user?.profile?.identity_provider === 'idir';\n}\n\n/**\n * Check if analytics was recorded recently for this app (within debounce window).\n */\nfunction wasRecentlyRecorded(appName: string): boolean {\n  const stored = sessionStorage.getItem(STORAGE_KEY);\n  if (!stored) return false;\n\n  try {\n    const { lastRecorded, appName: storedApp } = JSON.parse(stored);\n    const elapsed = Date.now() - lastRecorded;\n    return storedApp === appName && elapsed < DEBOUNCE_MS;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Save the current timestamp as last recorded for this app.\n */\nfunction saveRecordedTimestamp(appName: string): void {\n  sessionStorage.setItem(\n    STORAGE_KEY,\n    JSON.stringify({ lastRecorded: Date.now(), appName })\n  );\n}\n","import { User } from 'react-oidc-context';\nimport { UserInfo } from '../types';\n\n/**\n * Extract user_auth_guid from OIDC user object\n * Uses preferred_username as user_auth_guid\n */\nexport function extractUserInfo(user: User | null | undefined): UserInfo | null {\n  if (!user || !user.profile) {\n    return null;\n  }\n\n  const profile = user.profile;\n\n  const user_auth_guid = profile.preferred_username || profile.sub;\n  \n  if (!user_auth_guid) {\n    return null;\n  }\n\n  return {\n    user_auth_guid,\n  };\n}\n\n","import { EaoAnalyticsPayload } from '../types';\n\n/**\n * Record user login analytics by calling EPIC.centre API\n * @param apiUrl - Base URL of EPIC.centre API\n * @param accessToken - User's access token for authentication\n * @param payload - EAO Analytics payload\n */\nexport async function trackLogin(\n  apiUrl: string,\n  accessToken: string,\n  payload: EaoAnalyticsPayload\n): Promise<void> {\n  if (!apiUrl) {\n    throw new Error('EPIC.centre API URL is required');\n  }\n\n  if (!accessToken) {\n    throw new Error('Access token is required');\n  }\n\n  const baseUrl = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;\n  const endpoint = `${baseUrl}/api/eao-analytics`;\n\n  try {\n    const response = await fetch(endpoint, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify(payload),\n      keepalive: true,\n    });\n\n    if (!response.ok) {\n      throw new Error(\n        `EAO Analytics recording failed: ${response.status} ${response.statusText}`\n      );\n    }\n  } catch (error) {\n    throw error instanceof Error ? error : new Error('EAO Analytics recording failed: Unknown error');\n  }\n}\n\n"],"mappings":"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","names":[]}