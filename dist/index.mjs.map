{"version":3,"sources":["../src/EaoAnalytics.tsx","../src/utils/tokenExtractor.ts","../src/utils/apiClient.ts"],"sourcesContent":["import { useEffect, useRef, useState } from 'react';\nimport { extractUserInfo } from './utils/tokenExtractor';\nimport { trackLogin } from './utils/apiClient';\nimport { EaoAnalyticsOptions } from './types';\n\nconst DEBOUNCE_MS = 5000;\nconst STORAGE_KEY = 'epic_eao_analytics_last_recorded';\n\n/**\n * EaoAnalytics Component\n *\n * Drop-in component to record IDIR user login analytics.\n * Just render it anywhere in your app - no wrapping needed.\n *\n * @example\n * // Apps using react-oidc-context (Submit, Compliance, Conditions):\n * <EaoAnalytics appName=\"epic_submit\" centreApiUrl=\"...\" />\n *\n * @example\n * // Apps using Redux (Engage, Track):\n * <EaoAnalytics\n *   appName=\"epic_engage\"\n *   centreApiUrl=\"...\"\n *   authState={{ user, isAuthenticated }}\n * />\n */\nexport function EaoAnalytics(props: EaoAnalyticsOptions): null {\n    const {\n        appName,\n        centreApiUrl,\n        enabled = true,\n        onSuccess,\n        onError,\n        authState,\n    } = props;\n\n    // Get user from authState or react-oidc-context\n    const { user, isAuthenticated } = useAuthState(authState);\n\n    const [, setIsRecording] = useState(false);\n    const hasRecorded = useRef(false);\n\n    useEffect(() => {\n        // Skip if disabled, not authenticated, or already recorded\n        if (!enabled || !isAuthenticated || !user || hasRecorded.current) {\n            return;\n        }\n\n        // Skip if recorded recently (debounce)\n        if (wasRecentlyRecorded(appName)) {\n            return;\n        }\n\n        // For OIDC apps, check if user is IDIR. For Redux apps, assume IDIR-only.\n        if (!authState && !isIdirUser(user)) {\n            return;\n        }\n\n        // Extract user info\n        const userInfo = extractUserInfo(user);\n        if (!userInfo) {\n            console.warn('EAO Analytics: Could not extract user info');\n            return;\n        }\n\n        const accessToken = user.access_token;\n        if (!accessToken) {\n            console.warn('EAO Analytics: No access token available');\n            return;\n        }\n\n        // Record analytics\n        recordAnalytics();\n\n        async function recordAnalytics() {\n            hasRecorded.current = true;\n            setIsRecording(true);\n\n            try {\n                await trackLogin(centreApiUrl, accessToken, {\n                    user_auth_guid: userInfo!.user_auth_guid,\n                    app_name: appName,\n                });\n\n                saveRecordedTimestamp(appName);\n                onSuccess?.();\n            } catch (err) {\n                const e = err instanceof Error ? err : new Error('Unknown error');\n                onError?.(e);\n            } finally {\n                setIsRecording(false);\n                hasRecorded.current = false;\n            }\n        }\n    }, [isAuthenticated, user, appName, centreApiUrl, enabled, onSuccess, onError, authState]);\n\n    // Render nothing - this is a \"headless\" component\n    return null;\n}\n\n// --- Helper Functions ---\n\n/**\n * Get user from injected authState or dynamically load react-oidc-context.\n */\nfunction useAuthState(authState?: EaoAnalyticsOptions['authState']) {\n    // If authState is provided, use it directly (Redux apps)\n    if (authState) {\n        return {\n            user: authState.user,\n            isAuthenticated: authState.isAuthenticated,\n        };\n    }\n\n    // Otherwise, try to use react-oidc-context (OIDC apps)\n    // Dynamic import to make react-oidc-context optional\n    const useAuthHook = getUseAuthHook();\n    if (!useAuthHook) {\n        console.warn('EAO Analytics: react-oidc-context not available. Please provide authState.');\n        return { user: null, isAuthenticated: false };\n    }\n\n    // eslint-disable-next-line react-hooks/rules-of-hooks\n    const auth = useAuthHook();\n    return {\n        user: auth.user,\n        isAuthenticated: auth.isAuthenticated,\n    };\n}\n\n// Cached hook reference\nlet cachedUseAuth: any = undefined;\n\nfunction getUseAuthHook(): any {\n    if (cachedUseAuth !== undefined) return cachedUseAuth;\n\n    try {\n        // Access require via globalThis to avoid TypeScript errors\n        const g = globalThis as any;\n        if (g.require) {\n            cachedUseAuth = g.require('react-oidc-context').useAuth;\n        } else {\n            cachedUseAuth = null;\n        }\n    } catch {\n        cachedUseAuth = null;\n    }\n    return cachedUseAuth;\n}\n\n/**\n * Check if user has IDIR identity provider.\n */\nfunction isIdirUser(user: any): boolean {\n    return user?.profile?.identity_provider === 'idir';\n}\n\n/**\n * Check if analytics was recorded recently (within debounce window).\n */\nfunction wasRecentlyRecorded(appName: string): boolean {\n    const stored = sessionStorage.getItem(STORAGE_KEY);\n    if (!stored) return false;\n\n    try {\n        const { lastRecorded, appName: storedApp } = JSON.parse(stored);\n        const elapsed = Date.now() - lastRecorded;\n        return storedApp === appName && elapsed < DEBOUNCE_MS;\n    } catch {\n        return false;\n    }\n}\n\n/**\n * Save timestamp when analytics was recorded.\n */\nfunction saveRecordedTimestamp(appName: string): void {\n    sessionStorage.setItem(\n        STORAGE_KEY,\n        JSON.stringify({ lastRecorded: Date.now(), appName })\n    );\n}\n","import { User } from 'react-oidc-context';\nimport { UserInfo } from '../types';\n\n/**\n * Extract user_auth_guid from OIDC user object\n * Uses preferred_username as user_auth_guid\n */\nexport function extractUserInfo(user: User | null | undefined): UserInfo | null {\n  if (!user || !user.profile) {\n    return null;\n  }\n\n  const profile = user.profile;\n\n  const user_auth_guid = profile.preferred_username || profile.sub;\n  \n  if (!user_auth_guid) {\n    return null;\n  }\n\n  return {\n    user_auth_guid,\n  };\n}\n\n","import { EaoAnalyticsPayload } from '../types';\n\n/**\n * Record user login analytics by calling EPIC.centre API\n */\nexport async function trackLogin(\n  apiUrl: string,\n  accessToken: string,\n  payload: EaoAnalyticsPayload\n): Promise<void> {\n  if (!apiUrl) {\n    throw new Error('EPIC.centre API URL is required');\n  }\n\n  if (!accessToken) {\n    throw new Error('Access token is required');\n  }\n\n  const baseUrl = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;\n  const endpoint = `${baseUrl}/api/eao-analytics`;\n\n  const response = await fetch(endpoint, {\n    method: 'POST',\n    headers: {\n      'Authorization': `Bearer ${accessToken}`,\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify(payload),\n    keepalive: true,\n  });\n\n  if (!response.ok) {\n    throw new Error(`EAO Analytics failed: ${response.status} ${response.statusText}`);\n  }\n}\n"],"mappings":";AAAA,SAAS,WAAW,QAAQ,gBAAgB;;;ACOrC,SAAS,gBAAgB,MAAgD;AAC9E,MAAI,CAAC,QAAQ,CAAC,KAAK,SAAS;AAC1B,WAAO;AAAA,EACT;AAEA,QAAM,UAAU,KAAK;AAErB,QAAM,iBAAiB,QAAQ,sBAAsB,QAAQ;AAE7D,MAAI,CAAC,gBAAgB;AACnB,WAAO;AAAA,EACT;AAEA,SAAO;AAAA,IACL;AAAA,EACF;AACF;;;AClBA,eAAsB,WACpB,QACA,aACA,SACe;AACf,MAAI,CAAC,QAAQ;AACX,UAAM,IAAI,MAAM,iCAAiC;AAAA,EACnD;AAEA,MAAI,CAAC,aAAa;AAChB,UAAM,IAAI,MAAM,0BAA0B;AAAA,EAC5C;AAEA,QAAM,UAAU,OAAO,SAAS,GAAG,IAAI,OAAO,MAAM,GAAG,EAAE,IAAI;AAC7D,QAAM,WAAW,GAAG,OAAO;AAE3B,QAAM,WAAW,MAAM,MAAM,UAAU;AAAA,IACrC,QAAQ;AAAA,IACR,SAAS;AAAA,MACP,iBAAiB,UAAU,WAAW;AAAA,MACtC,gBAAgB;AAAA,IAClB;AAAA,IACA,MAAM,KAAK,UAAU,OAAO;AAAA,IAC5B,WAAW;AAAA,EACb,CAAC;AAED,MAAI,CAAC,SAAS,IAAI;AAChB,UAAM,IAAI,MAAM,yBAAyB,SAAS,MAAM,IAAI,SAAS,UAAU,EAAE;AAAA,EACnF;AACF;;;AF7BA,IAAM,cAAc;AACpB,IAAM,cAAc;AAoBb,SAAS,aAAa,OAAkC;AAC3D,QAAM;AAAA,IACF;AAAA,IACA;AAAA,IACA,UAAU;AAAA,IACV;AAAA,IACA;AAAA,IACA;AAAA,EACJ,IAAI;AAGJ,QAAM,EAAE,MAAM,gBAAgB,IAAI,aAAa,SAAS;AAExD,QAAM,CAAC,EAAE,cAAc,IAAI,SAAS,KAAK;AACzC,QAAM,cAAc,OAAO,KAAK;AAEhC,YAAU,MAAM;AAEZ,QAAI,CAAC,WAAW,CAAC,mBAAmB,CAAC,QAAQ,YAAY,SAAS;AAC9D;AAAA,IACJ;AAGA,QAAI,oBAAoB,OAAO,GAAG;AAC9B;AAAA,IACJ;AAGA,QAAI,CAAC,aAAa,CAAC,WAAW,IAAI,GAAG;AACjC;AAAA,IACJ;AAGA,UAAM,WAAW,gBAAgB,IAAI;AACrC,QAAI,CAAC,UAAU;AACX,cAAQ,KAAK,4CAA4C;AACzD;AAAA,IACJ;AAEA,UAAM,cAAc,KAAK;AACzB,QAAI,CAAC,aAAa;AACd,cAAQ,KAAK,0CAA0C;AACvD;AAAA,IACJ;AAGA,oBAAgB;AAEhB,mBAAe,kBAAkB;AAC7B,kBAAY,UAAU;AACtB,qBAAe,IAAI;AAEnB,UAAI;AACA,cAAM,WAAW,cAAc,aAAa;AAAA,UACxC,gBAAgB,SAAU;AAAA,UAC1B,UAAU;AAAA,QACd,CAAC;AAED,8BAAsB,OAAO;AAC7B,oBAAY;AAAA,MAChB,SAAS,KAAK;AACV,cAAM,IAAI,eAAe,QAAQ,MAAM,IAAI,MAAM,eAAe;AAChE,kBAAU,CAAC;AAAA,MACf,UAAE;AACE,uBAAe,KAAK;AACpB,oBAAY,UAAU;AAAA,MAC1B;AAAA,IACJ;AAAA,EACJ,GAAG,CAAC,iBAAiB,MAAM,SAAS,cAAc,SAAS,WAAW,SAAS,SAAS,CAAC;AAGzF,SAAO;AACX;AAOA,SAAS,aAAa,WAA8C;AAEhE,MAAI,WAAW;AACX,WAAO;AAAA,MACH,MAAM,UAAU;AAAA,MAChB,iBAAiB,UAAU;AAAA,IAC/B;AAAA,EACJ;AAIA,QAAM,cAAc,eAAe;AACnC,MAAI,CAAC,aAAa;AACd,YAAQ,KAAK,4EAA4E;AACzF,WAAO,EAAE,MAAM,MAAM,iBAAiB,MAAM;AAAA,EAChD;AAGA,QAAM,OAAO,YAAY;AACzB,SAAO;AAAA,IACH,MAAM,KAAK;AAAA,IACX,iBAAiB,KAAK;AAAA,EAC1B;AACJ;AAGA,IAAI,gBAAqB;AAEzB,SAAS,iBAAsB;AAC3B,MAAI,kBAAkB,OAAW,QAAO;AAExC,MAAI;AAEA,UAAM,IAAI;AACV,QAAI,EAAE,SAAS;AACX,sBAAgB,EAAE,QAAQ,oBAAoB,EAAE;AAAA,IACpD,OAAO;AACH,sBAAgB;AAAA,IACpB;AAAA,EACJ,QAAQ;AACJ,oBAAgB;AAAA,EACpB;AACA,SAAO;AACX;AAKA,SAAS,WAAW,MAAoB;AACpC,SAAO,MAAM,SAAS,sBAAsB;AAChD;AAKA,SAAS,oBAAoB,SAA0B;AACnD,QAAM,SAAS,eAAe,QAAQ,WAAW;AACjD,MAAI,CAAC,OAAQ,QAAO;AAEpB,MAAI;AACA,UAAM,EAAE,cAAc,SAAS,UAAU,IAAI,KAAK,MAAM,MAAM;AAC9D,UAAM,UAAU,KAAK,IAAI,IAAI;AAC7B,WAAO,cAAc,WAAW,UAAU;AAAA,EAC9C,QAAQ;AACJ,WAAO;AAAA,EACX;AACJ;AAKA,SAAS,sBAAsB,SAAuB;AAClD,iBAAe;AAAA,IACX;AAAA,IACA,KAAK,UAAU,EAAE,cAAc,KAAK,IAAI,GAAG,QAAQ,CAAC;AAAA,EACxD;AACJ;","names":[]}